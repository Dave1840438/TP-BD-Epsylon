ALTER SESSION SET NLS_DATE_FORMAT='YYYY-MM-DD';

DROP TABLE EMPRUNTS;
DROP TABLE ADHERENTS;
DROP TABLE EXEMPLAIRES;
DROP TABLE LIVRES;
DROP TABLE MAISONSEDITION;
DROP TABLE GENRES;
DROP SEQUENCE SEQ_ADHERENTS;

CREATE SEQUENCE SEQ_ADHERENTS START WITH 1 INCREMENT BY 1;



CREATE TABLE GENRES (
NUMERO NUMBER PRIMARY KEY,
DESCRIPTION NVARCHAR2(50)
);

CREATE TABLE MAISONSEDITION (
NUMERO NUMBER PRIMARY KEY,
NOM NVARCHAR2(50)
);

CREATE TABLE LIVRES (
NUMERO NUMBER PRIMARY KEY,
TITRE NVARCHAR2(50),
AUTEUR NVARCHAR2(50),
GENRE NUMBER, 
DATEPARUTION DATE,
MAISONEDITION NUMBER,
CONSTRAINT FK_GENRE FOREIGN KEY (GENRE) REFERENCES GENRES(NUMERO),
CONSTRAINT FK_MAISONEDITION FOREIGN KEY (MAISONEDITION) REFERENCES MAISONSEDITION(NUMERO)
);

CREATE TABLE EXEMPLAIRES (
NUMERO NUMBER PRIMARY KEY,
LIVRE NUMBER,
CONSTRAINT FK_LIVRE FOREIGN KEY (LIVRE) REFERENCES LIVRES(NUMERO)
);

CREATE TABLE ADHERENTS (
NUMERO NUMBER PRIMARY KEY,
NOM NVARCHAR2(50),
PRENOM NVARCHAR2(50),
ADRESSE NVARCHAR2(250),
NUMEROTEL NVARCHAR2(15)
);

CREATE TABLE EMPRUNTS (
NUMEROEXEMPLAIRE NUMBER,
NUMEROADHERENT NUMBER,
DATEDEBUT DATE,
DATERETOUR DATE,
CONSTRAINT PK_COMPOSED PRIMARY KEY (NUMEROEXEMPLAIRE, NUMEROADHERENT, DATEDEBUT),
CONSTRAINT FK_NUMEROEXEMPLAIRE FOREIGN KEY (NUMEROEXEMPLAIRE) REFERENCES EXEMPLAIRES(NUMERO),
CONSTRAINT FK_NUMEROADHERENT FOREIGN KEY (NUMEROADHERENT) REFERENCES ADHERENTS(NUMERO)
);





INSERT INTO GENRES VALUES(1, 'ENCYCLOPEDIE');
INSERT INTO GENRES VALUES(2, 'HORREUR');
INSERT INTO GENRES VALUES(3, 'SCIENCE-FICTION');

INSERT INTO MAISONSEDITION VALUES(1, 'LA VRAIE INFORMATION');
INSERT INTO MAISONSEDITION VALUES(2, 'LA MAISON DE L''HORREUR');
INSERT INTO MAISONSEDITION VALUES(3, 'LE TROU DE L''EMERVEILLEMENT');

INSERT INTO LIVRES VALUES(1, 'LES AMPHIBIENS', 'LACHENAI', '1', '2014-03-04', '1');
INSERT INTO LIVRES VALUES(2, 'LES CROCODILES', 'CROCDUR', '1', '2014-01-12', '1');
INSERT INTO LIVRES VALUES(3, 'LE CORPS HUMAIN', 'LE PROF DE BIO', '1', '2007-05-07', '1');
INSERT INTO LIVRES VALUES(4, 'GODZILLA', 'LHOMME ABEILLE', '2', '2014-11-14', '2');
INSERT INTO LIVRES VALUES(5, 'GET RICK ROLLED', 'RICK ASTLEY', '2', '2014-07-04', '2');
INSERT INTO LIVRES VALUES(6, 'LA MAISON HANTEE', 'A. TREMBLAY', '2', '2015-03-04', '2');
INSERT INTO LIVRES VALUES(7, 'BOBBY PENDRAGON', 'C. CARDINAL', '3', '2011-09-17', '3');
INSERT INTO LIVRES VALUES(8, 'QUOI?!, UN ROMAN DE SCI-FI?', 'STEPEHN KING', '3', '2010-04-04', '3');
INSERT INTO LIVRES VALUES(9, 'AMOS D''ARAGON', 'BRYAN PERRO', '3', '2013-05-07', '3');

INSERT INTO EXEMPLAIRES VALUES(1, 1);
INSERT INTO EXEMPLAIRES VALUES(2, 1);
INSERT INTO EXEMPLAIRES VALUES(3, 2);
INSERT INTO EXEMPLAIRES VALUES(4, 2);
INSERT INTO EXEMPLAIRES VALUES(5, 3);
INSERT INTO EXEMPLAIRES VALUES(6, 3);
INSERT INTO EXEMPLAIRES VALUES(7, 4);
INSERT INTO EXEMPLAIRES VALUES(8, 4);
INSERT INTO EXEMPLAIRES VALUES(9, 5);
INSERT INTO EXEMPLAIRES VALUES(10, 5);
INSERT INTO EXEMPLAIRES VALUES(11, 6);
INSERT INTO EXEMPLAIRES VALUES(12, 6);
INSERT INTO EXEMPLAIRES VALUES(13, 7);
INSERT INTO EXEMPLAIRES VALUES(14, 7);
INSERT INTO EXEMPLAIRES VALUES(15, 8);
INSERT INTO EXEMPLAIRES VALUES(16, 8);
INSERT INTO EXEMPLAIRES VALUES(17, 9);
INSERT INTO EXEMPLAIRES VALUES(18, 9);

SELECT COUNT(L.TITRE) AS NOMBREEMPRUNTS, L.TITRE, L.AUTEUR, G.DESCRIPTION, M.NOM, L.DATEPARUTION  FROM EMPRUNTS EM 
INNER JOIN EXEMPLAIRES EX ON EX.NUMERO = EM.NUMEROEXEMPLAIRE
INNER JOIN LIVRES L ON L.NUMERO = EX.LIVRE
INNER JOIN GENRES G ON G.NUMERO = L.GENRE
INNER JOIN MAISONSEDITION M ON M.NUMERO = L.MAISONEDITION
GROUP BY L.TITRE, L.AUTEUR, G.DESCRIPTION, M.NOM, L.DATEPARUTION ORDER BY NOMBREEMPRUNTS DESC;

COMMIT;





CREATE SEQUENCE SEQ_ADHERENTS START WITH 1 INCREMENT BY 1;


create or replace TRIGGER ID_ADHERENT BEFORE INSERT ON ADHERENTS
FOR EACH ROW
BEGIN

:NEW.NUMERO := SEQ_ADHERENTS.NEXTVAL;


END;
